"use strict";(globalThis.webpackChunkdocumentation=globalThis.webpackChunkdocumentation||[]).push([[3370],{349:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>m,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"ocolecionadoraugmentations","title":"OColecionadorAugmentations","description":"\ud83d\udccb Vis\xe3o Geral","source":"@site/docs/ocolecionadoraugmentations.md","sourceDirName":".","slug":"/ocolecionadoraugmentations","permalink":"/OColecionador/docs/ocolecionadoraugmentations","draft":false,"unlisted":false,"editUrl":"https://github.com/PatrickCalorioCarvalho/OColecionador/edit/main/Documentation/docs/docs/ocolecionadoraugmentations.md","tags":[],"version":"current","frontMatter":{"id":"ocolecionadoraugmentations","title":"OColecionadorAugmentations","sidebar_label":"Introdu\xe7\xe3o"},"sidebar":"docs","previous":{"title":"Avan\xe7ado","permalink":"/OColecionador/docs/ocolecionadorbackend-advanced"},"next":{"title":"Avan\xe7ado","permalink":"/OColecionador/docs/ocolecionadoraugmentations-advanced"}}');var i=a(4848),o=a(8453);const s={id:"ocolecionadoraugmentations",title:"OColecionadorAugmentations",sidebar_label:"Introdu\xe7\xe3o"},t="OColecionadorAugmentations \ud83c\udfa8",l={},c=[{value:"\ud83d\udccb Vis\xe3o Geral",id:"-vis\xe3o-geral",level:2},{value:"Responsabilidades Principais",id:"responsabilidades-principais",level:3},{value:"\ud83c\udfd7\ufe0f Arquitetura",id:"\ufe0f-arquitetura",level:2},{value:"Estrutura de Pastas",id:"estrutura-de-pastas",level:3},{value:"\ud83d\udce6 Depend\xeancias Principais",id:"-depend\xeancias-principais",level:2},{value:"\ud83d\udd0c Fluxo Principal",id:"-fluxo-principal",level:2},{value:"\ud83c\udfa8 Tipos de Augmentations",id:"-tipos-de-augmentations",level:2},{value:"1. <strong>Rota\xe7\xe3o</strong>",id:"1-rota\xe7\xe3o",level:3},{value:"2. <strong>Flip (Espelhamento)</strong>",id:"2-flip-espelhamento",level:3},{value:"3. <strong>Brilho e Contraste</strong>",id:"3-brilho-e-contraste",level:3},{value:"4. <strong>Crop Central</strong>",id:"4-crop-central",level:3},{value:"5. <strong>Blur Gaussiano</strong>",id:"5-blur-gaussiano",level:3},{value:"6. <strong>Mudan\xe7a de Cores</strong>",id:"6-mudan\xe7a-de-cores",level:3},{value:"7. <strong>CLAHE (Contrast Limited Adaptive Histogram Equalization)</strong>",id:"7-clahe-contrast-limited-adaptive-histogram-equalization",level:3},{value:"\ud83d\udce8 Formato de Mensagem RabbitMQ",id:"-formato-de-mensagem-rabbitmq",level:2},{value:"Input (Consumo)",id:"input-consumo",level:3},{value:"Output (Publica\xe7\xe3o ap\xf3s sucesso)",id:"output-publica\xe7\xe3o-ap\xf3s-sucesso",level:3},{value:"\ud83d\uddc4\ufe0f Estrutura de Dados PostgreSQL",id:"\ufe0f-estrutura-de-dados-postgresql",level:2},{value:"Tabela: augmentation_jobs",id:"tabela-augmentation_jobs",level:3},{value:"Tabela: augmentation_results",id:"tabela-augmentation_results",level:3},{value:"\ud83d\udd27 Configura\xe7\xe3o",id:"-configura\xe7\xe3o",level:2},{value:"Vari\xe1veis de Ambiente (.env)",id:"vari\xe1veis-de-ambiente-env",level:3},{value:"\ud83d\ude80 Estrutura de C\xf3digo (main.py)",id:"-estrutura-de-c\xf3digo-mainpy",level:2},{value:"\ud83d\udc33 Docker",id:"-docker",level:2},{value:"Dockerfile",id:"dockerfile",level:3},{value:"requirements.txt",id:"requirementstxt",level:3},{value:"\ud83d\udd04 Retry Logic",id:"-retry-logic",level:2},{value:"\ud83d\udcca Exemplo de Fluxo Completo",id:"-exemplo-de-fluxo-completo",level:2},{value:"\ud83c\udfaf Performance",id:"-performance",level:2},{value:"\ud83d\udd17 Integra\xe7\xe3o com Backend",id:"-integra\xe7\xe3o-com-backend",level:2},{value:"1. Backend publica mensagem",id:"1-backend-publica-mensagem",level:3},{value:"2. Augmentations processa",id:"2-augmentations-processa",level:3},{value:"3. Publica para Training (opcional)",id:"3-publica-para-training-opcional",level:3},{value:"\ud83d\udcdd Conclus\xe3o",id:"-conclus\xe3o",level:2}];function d(e){const n={br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"ocolecionadoraugmentations-",children:"OColecionadorAugmentations \ud83c\udfa8"})}),"\n",(0,i.jsx)(n.h2,{id:"-vis\xe3o-geral",children:"\ud83d\udccb Vis\xe3o Geral"}),"\n",(0,i.jsxs)(n.p,{children:["O ",(0,i.jsx)(n.strong,{children:"OColecionadorAugmentations"})," \xe9 um servi\xe7o Python que consome mensagens de uma fila ",(0,i.jsx)(n.strong,{children:"RabbitMQ"}),", baixa imagens do ",(0,i.jsx)(n.strong,{children:"MinIO"}),", aplica ",(0,i.jsx)(n.strong,{children:"transforma\xe7\xf5es (augmentations)"})," usando bibliotecas de Computer Vision, e salva as varia\xe7\xf5es processadas."]}),"\n",(0,i.jsx)(n.h3,{id:"responsabilidades-principais",children:"Responsabilidades Principais"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\ud83d\udce8 ",(0,i.jsx)(n.strong,{children:"Consumo de Fila"})," \u2013 Escuta mensagens do RabbitMQ"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udce5 ",(0,i.jsx)(n.strong,{children:"Download de Imagens"})," \u2013 Recupera originais do MinIO"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83c\udfa8 ",(0,i.jsx)(n.strong,{children:"Transforma\xe7\xf5es"})," \u2013 Rota\xe7\xe3o, flip, brilho, contraste, crop, etc."]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udce4 ",(0,i.jsx)(n.strong,{children:"Upload de Varia\xe7\xf5es"})," \u2013 Salva processadas no MinIO"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udcbe ",(0,i.jsx)(n.strong,{children:"Persist\xeancia de Metadados"})," \u2013 Registra opera\xe7\xf5es no PostgreSQL"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udd04 ",(0,i.jsx)(n.strong,{children:"Retry Logic"})," \u2013 Reprocessa falhas com backoff exponencial"]}),"\n",(0,i.jsxs)(n.li,{children:["\ud83d\udcca ",(0,i.jsx)(n.strong,{children:"Logging e Monitoramento"})," \u2013 Rastreia execu\xe7\xe3o e erros"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-arquitetura",children:"\ud83c\udfd7\ufe0f Arquitetura"}),"\n",(0,i.jsx)(n.h3,{id:"estrutura-de-pastas",children:"Estrutura de Pastas"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"OColecionadorAugmentations/\r\n\u251c\u2500\u2500 main.py                    # Ponto de entrada principal\r\n\u251c\u2500\u2500 requirements.txt           # Depend\xeancias Python\r\n\u251c\u2500\u2500 Dockerfile                 # Imagem Docker\r\n\u251c\u2500\u2500 init_db.sql               # Script de inicializa\xe7\xe3o PostgreSQL\r\n\u2514\u2500\u2500 [m\xf3dulos Python esperados]\r\n    \u251c\u2500\u2500 config.py             # Configura\xe7\xf5es\r\n    \u251c\u2500\u2500 rabbitmq_consumer.py  # Consumer RabbitMQ\r\n    \u251c\u2500\u2500 minio_handler.py      # Handler MinIO\r\n    \u251c\u2500\u2500 augmentations.py      # Fun\xe7\xf5es de augmentation\r\n    \u251c\u2500\u2500 database.py           # Conex\xe3o PostgreSQL\r\n    \u2514\u2500\u2500 logger.py             # Logging centralizado\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-depend\xeancias-principais",children:"\ud83d\udce6 Depend\xeancias Principais"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"Python 3.11+\r\n\u251c\u2500\u2500 pika              # RabbitMQ Client\r\n\u251c\u2500\u2500 minio             # MinIO/S3 Client\r\n\u251c\u2500\u2500 opencv-python    # Processamento de imagens\r\n\u251c\u2500\u2500 pillow            # Manipula\xe7\xe3o de imagens\r\n\u251c\u2500\u2500 numpy             # Computa\xe7\xe3o num\xe9rica\r\n\u251c\u2500\u2500 psycopg2-binary   # PostgreSQL Client\r\n\u251c\u2500\u2500 python-dotenv     # Vari\xe1veis de ambiente\r\n\u2514\u2500\u2500 albumentations    # Augmentations avan\xe7adas (opcional)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-fluxo-principal",children:"\ud83d\udd0c Fluxo Principal"}),"\n",(0,i.jsx)(n.mermaid,{value:'graph LR\r\n    A["\ud83d\udce8 RabbitMQ"] --\x3e|Mensagem| B["\ud83c\udfa8 Augmentations Service"]\r\n    B --\x3e|Download| C["\ud83d\udce6 MinIO<br/>bucket: original"]\r\n    B --\x3e|Processa| D["\ud83d\udd04 Transforma\xe7\xf5es"]\r\n    D --\x3e|Upload| E["\ud83d\udce6 MinIO<br/>bucket: processed"]\r\n    D --\x3e|Salva metadados| F["\ud83d\udcbe PostgreSQL"]\r\n    B --\x3e|Erro| G["\ud83d\udd01 Retry Queue"]'}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-tipos-de-augmentations",children:"\ud83c\udfa8 Tipos de Augmentations"}),"\n",(0,i.jsxs)(n.h3,{id:"1-rota\xe7\xe3o",children:["1. ",(0,i.jsx)(n.strong,{children:"Rota\xe7\xe3o"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Rota\xe7\xf5es: 90\xb0, 180\xb0, 270\xb0\r\nrotated_90 = cv2.rotate(image, cv2.ROTATE_90_CLOCKWISE)\r\nrotated_180 = cv2.rotate(image, cv2.ROTATE_180)\r\nrotated_270 = cv2.rotate(image, cv2.ROTATE_90_COUNTERCLOCKWISE)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"2-flip-espelhamento",children:["2. ",(0,i.jsx)(n.strong,{children:"Flip (Espelhamento)"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Horizontal e vertical\r\nflipped_h = cv2.flip(image, 1)   # Eixo Y\r\nflipped_v = cv2.flip(image, 0)   # Eixo X\r\nflipped_both = cv2.flip(image, -1)  # Ambos\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"3-brilho-e-contraste",children:["3. ",(0,i.jsx)(n.strong,{children:"Brilho e Contraste"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Ajuste de intensidade\r\nalpha = 1.2  # Contraste\r\nbeta = 30    # Brilho\r\nadjusted = cv2.convertScaleAbs(image, alpha=alpha, beta=beta)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"4-crop-central",children:["4. ",(0,i.jsx)(n.strong,{children:"Crop Central"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Extrai regi\xe3o central (80% da imagem)\r\nh, w = image.shape[:2]\r\ncrop_size = int(0.8 * min(h, w))\r\ny = (h - crop_size) // 2\r\nx = (w - crop_size) // 2\r\ncropped = image[y:y+crop_size, x:x+crop_size]\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"5-blur-gaussiano",children:["5. ",(0,i.jsx)(n.strong,{children:"Blur Gaussiano"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Desfoque para robustez\r\nblurred = cv2.GaussianBlur(image, (5, 5), 0)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"6-mudan\xe7a-de-cores",children:["6. ",(0,i.jsx)(n.strong,{children:"Mudan\xe7a de Cores"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# De RGB para HSV, ajusta, converte de volta\r\nhsv = cv2.cvtColor(image, cv2.COLOR_RGB2HSV)\r\nhsv[:, :, 0] = (hsv[:, :, 0] + 30) % 180  # Muda tom\r\ncolored = cv2.cvtColor(hsv, cv2.COLOR_HSV2RGB)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h3,{id:"7-clahe-contrast-limited-adaptive-histogram-equalization",children:["7. ",(0,i.jsx)(n.strong,{children:"CLAHE (Contrast Limited Adaptive Histogram Equalization)"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Melhora contraste local\r\nclahe = cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8, 8))\r\nenhanced = clahe.apply(cv2.cvtColor(image, cv2.COLOR_RGB2GRAY))\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-formato-de-mensagem-rabbitmq",children:"\ud83d\udce8 Formato de Mensagem RabbitMQ"}),"\n",(0,i.jsx)(n.h3,{id:"input-consumo",children:"Input (Consumo)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "itemId": 12345,\r\n  "fotoCaminho": "item/12345/original.jpg",\r\n  "categoria": "carros",\r\n  "uploadedAt": "2025-11-15T10:30:00Z"\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"output-publica\xe7\xe3o-ap\xf3s-sucesso",children:"Output (Publica\xe7\xe3o ap\xf3s sucesso)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "itemId": 12345,\r\n  "categoria": "carros",\r\n  "totalAugmentacoes": 10,\r\n  "processadas": [\r\n    {\r\n      "variacao": "rotated_90",\r\n      "caminho": "training/carros/12345_rotated_90.jpg",\r\n      "timestamp": "2025-11-15T10:35:00Z"\r\n    },\r\n    {\r\n      "variacao": "flipped_h",\r\n      "caminho": "training/carros/12345_flipped_h.jpg",\r\n      "timestamp": "2025-11-15T10:35:01Z"\r\n    }\r\n  ],\r\n  "status": "success"\r\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-estrutura-de-dados-postgresql",children:"\ud83d\uddc4\ufe0f Estrutura de Dados PostgreSQL"}),"\n",(0,i.jsx)(n.h3,{id:"tabela-augmentation_jobs",children:"Tabela: augmentation_jobs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE augmentation_jobs (\r\n    id SERIAL PRIMARY KEY,\r\n    item_id INT NOT NULL,\r\n    original_path VARCHAR(255) NOT NULL,\r\n    categoria VARCHAR(50),\r\n    status VARCHAR(20) DEFAULT 'pending', -- pending, processing, success, failed\r\n    total_augmentations INT DEFAULT 0,\r\n    processed_count INT DEFAULT 0,\r\n    error_message TEXT,\r\n    attempts INT DEFAULT 0,\r\n    max_attempts INT DEFAULT 3,\r\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    completed_at TIMESTAMP\r\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"tabela-augmentation_results",children:"Tabela: augmentation_results"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE augmentation_results (\r\n    id SERIAL PRIMARY KEY,\r\n    job_id INT REFERENCES augmentation_jobs(id),\r\n    variation_type VARCHAR(50), -- rotated_90, flipped_h, etc.\r\n    output_path VARCHAR(255) NOT NULL,\r\n    file_size INT,\r\n    dimensions VARCHAR(20), -- 224x224\r\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n);\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-configura\xe7\xe3o",children:"\ud83d\udd27 Configura\xe7\xe3o"}),"\n",(0,i.jsx)(n.h3,{id:"vari\xe1veis-de-ambiente-env",children:"Vari\xe1veis de Ambiente (.env)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# RabbitMQ\r\nRABBITMQ_HOST=rabbitmq\r\nRABBITMQ_PORT=5672\r\nRABBITMQ_USER=OColecionadorUser\r\nRABBITMQ_PASSWORD=OColecionador@2025\r\nRABBITMQ_QUEUE=ImageAugmentations\r\n\r\n# MinIO\r\nMINIO_HOST=minio\r\nMINIO_PORT=9000\r\nMINIO_ACCESS_KEY=OColecionadorUser\r\nMINIO_SECRET_KEY=OColecionador@2025\r\nMINIO_BUCKET_ORIGINAL=ocolecionadorbucket-original\r\nMINIO_BUCKET_PROCESSED=ocolecionadorbucket-processed\r\nMINIO_REGION=us-east-1\r\n\r\n# PostgreSQL\r\nDB_HOST=postgres\r\nDB_PORT=5432\r\nDB_NAME=augmentations_db\r\nDB_USER=OColecionadorUser\r\nDB_PASSWORD=OColecionador@2025\r\n\r\n# Logging\r\nLOG_LEVEL=INFO\r\nLOG_FILE=/logs/augmentations.log\r\n\r\n# Augmentations Config\r\nAUGMENTATION_TYPES=rotated_90,rotated_180,rotated_270,flipped_h,flipped_v,brightness_up,brightness_down,blur,clahe\r\nAUGMENTATION_COUNT=9\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-estrutura-de-c\xf3digo-mainpy",children:"\ud83d\ude80 Estrutura de C\xf3digo (main.py)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# main.py - Ponto de entrada\r\n\r\nimport pika\r\nimport json\r\nimport logging\r\nfrom datetime import datetime\r\nfrom minio import Minio\r\nimport psycopg2\r\n\r\n# Configura\xe7\xe3o\r\nRABBITMQ_URL = f"amqp://{RABBITMQ_USER}:{RABBITMQ_PASSWORD}@{RABBITMQ_HOST}:{RABBITMQ_PORT}/"\r\nQUEUE_NAME = "ImageAugmentations"\r\n\r\n# Conex\xf5es\r\nminio_client = Minio(...)\r\ndb_connection = psycopg2.connect(...)\r\n\r\ndef process_message(ch, method, properties, body):\r\n    """Callback para processar mensagem do RabbitMQ"""\r\n    try:\r\n        message = json.loads(body)\r\n        item_id = message[\'itemId\']\r\n        foto_caminho = message[\'fotoCaminho\']\r\n        categoria = message[\'categoria\']\r\n        \r\n        # Download imagem original\r\n        image = minio_client.fget_object(\r\n            bucket_name=\'ocolecionadorbucket-original\',\r\n            object_name=foto_caminho\r\n        )\r\n        \r\n        # Aplicar augmentations\r\n        augmentations = apply_augmentations(image)\r\n        \r\n        # Upload varia\xe7\xf5es\r\n        for aug_name, aug_image in augmentations.items():\r\n            output_path = f"training/{categoria}/{item_id}_{aug_name}.jpg"\r\n            minio_client.fput_object(\r\n                bucket_name=\'ocolecionadorbucket-processed\',\r\n                object_name=output_path,\r\n                file_path=aug_image\r\n            )\r\n            \r\n            # Salvar metadados\r\n            save_augmentation_result(item_id, aug_name, output_path)\r\n        \r\n        # Confirmar processamento\r\n        ch.basic_ack(delivery_tag=method.delivery_tag)\r\n        logging.info(f"Item {item_id} processado com sucesso")\r\n        \r\n    except Exception as e:\r\n        logging.error(f"Erro ao processar item: {str(e)}")\r\n        # Requeue para retry\r\n        ch.basic_nack(delivery_tag=method.delivery_tag, requeue=True)\r\n\r\ndef apply_augmentations(image):\r\n    """Aplica todas as transforma\xe7\xf5es \xe0 imagem"""\r\n    augmentations = {}\r\n    augmentations[\'rotated_90\'] = cv2.rotate(image, cv2.ROTATE_90_CLOCKWISE)\r\n    augmentations[\'rotated_180\'] = cv2.rotate(image, cv2.ROTATE_180)\r\n    # ... mais transforma\xe7\xf5es\r\n    return augmentations\r\n\r\ndef main():\r\n    """Fun\xe7\xe3o principal - inicia consumer"""\r\n    connection = pika.BlockingConnection(pika.URLParameters(RABBITMQ_URL))\r\n    channel = connection.channel()\r\n    \r\n    channel.queue_declare(queue=QUEUE_NAME, durable=True)\r\n    channel.basic_consume(\r\n        queue=QUEUE_NAME,\r\n        on_message_callback=process_message,\r\n        auto_ack=False\r\n    )\r\n    \r\n    logging.info("[*] Aguardando mensagens...")\r\n    channel.start_consuming()\r\n\r\nif __name__ == \'__main__\':\r\n    main()\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-docker",children:"\ud83d\udc33 Docker"}),"\n",(0,i.jsx)(n.h3,{id:"dockerfile",children:"Dockerfile"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:'FROM python:3.11-slim\r\n\r\nWORKDIR /app\r\n\r\n# Depend\xeancias do sistema\r\nRUN apt-get update && apt-get install -y \\\r\n    libsm6 libxext6 libxrender-dev \\\r\n    postgresql-client \\\r\n    && rm -rf /var/lib/apt/lists/*\r\n\r\n# Copiar requirements\r\nCOPY requirements.txt .\r\nRUN pip install --no-cache-dir -r requirements.txt\r\n\r\n# Copiar c\xf3digo\r\nCOPY . .\r\n\r\n# Health check\r\nHEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\\r\n    CMD python -c "import pika; pika.BlockingConnection(pika.ConnectionParameters(\'rabbitmq\'))"\r\n\r\n# Executar\r\nCMD ["python", "main.py"]\n'})}),"\n",(0,i.jsx)(n.h3,{id:"requirementstxt",children:"requirements.txt"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-txt",children:"pika==1.3.1\r\nminio==7.1.15\r\nopencv-python==4.8.1.78\r\npillow==10.1.0\r\nnumpy==1.24.3\r\npsycopg2-binary==2.9.9\r\npython-dotenv==1.0.0\r\nalbumentations==1.3.1\r\nPillow==10.1.0\r\nrequests==2.31.0\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-retry-logic",children:"\ud83d\udd04 Retry Logic"}),"\n",(0,i.jsx)(n.mermaid,{value:'graph TD\r\n    A["\ud83d\udce8 Mensagem RabbitMQ"] --\x3e|Primeiro processamento| B["\ud83d\udd04 Tenta processar"]\r\n    B --\x3e|\u274c Erro| C["Attempts++"]\r\n    C --\x3e|attempts < 3| D["Aguarda 5s * 2^attempts"]\r\n    D --\x3e|Requeue| B\r\n    C --\x3e|attempts >= 3| E["\ud83d\udce4 Move para Dead Letter Queue"]\r\n    E --\x3e|Monitoramento| F["\ud83d\udea8 Alert para Backend"]\r\n    B --\x3e|\u2705 Sucesso| G["\u2713 ACK"]\r\n    G --\x3e|Publica resultado| H["\ud83d\udce4 Fila ModelTraining"]'}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-exemplo-de-fluxo-completo",children:"\ud83d\udcca Exemplo de Fluxo Completo"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\r\n    participant Backend as \ud83d\udd0c Backend\r\n    participant RabbitMQ as \ud83d\udce8 RabbitMQ\r\n    participant Augmentations as \ud83c\udfa8 Augmentations\r\n    participant MinIO as \ud83d\udce6 MinIO\r\n    participant PostgreSQL as \ud83d\udcbe PostgreSQL\r\n\r\n    Backend->>RabbitMQ: PublishMessage { itemId: 1, fotoCaminho: 'item/1/original.jpg' }\r\n    \r\n    RabbitMQ->>Augmentations: Delivery (consumer ativo)\r\n    Augmentations->>PostgreSQL: INSERT augmentation_jobs (status: processing)\r\n    \r\n    Augmentations->>MinIO: DownloadFile (bucket: original)\r\n    MinIO--\x3e>Augmentations: Imagem bytes\r\n    \r\n    Augmentations->>Augmentations: Aplicar 9 transforma\xe7\xf5es\r\n    \r\n    loop Para cada transforma\xe7\xe3o\r\n        Augmentations->>MinIO: UploadFile (bucket: processed)\r\n        Augmentations->>PostgreSQL: INSERT augmentation_results\r\n    end\r\n    \r\n    Augmentations->>PostgreSQL: UPDATE augmentation_jobs (status: success)\r\n    Augmentations->>RabbitMQ: PublishMessage (fila: ModelTraining)\r\n    Augmentations->>RabbitMQ: NACK e ACK"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-performance",children:"\ud83c\udfaf Performance"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tempo por item:"})," ~2-5 segundos (9 augmentations)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mem\xf3ria por processo:"})," ~500MB - 1GB"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Taxa de processamento:"})," ~1000-2000 imagens/hora (1 container)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Escalabilidade:"})," M\xfaltiplos containers consumindo mesma fila"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-integra\xe7\xe3o-com-backend",children:"\ud83d\udd17 Integra\xe7\xe3o com Backend"}),"\n",(0,i.jsx)(n.h3,{id:"1-backend-publica-mensagem",children:"1. Backend publica mensagem"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Backend .NET\r\nawait rabbitService.PublishMessageAsync("ImageAugmentations", {\r\n    itemId = 1,\r\n    fotoCaminho = "item/1/original.jpg",\r\n    categoria = "carros"\r\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"2-augmentations-processa",children:"2. Augmentations processa"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# Augmentations Python\r\ndef process_message(message):\r\n    # Download, augment, upload\r\n    pass\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-publica-para-training-opcional",children:"3. Publica para Training (opcional)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"channel.basic_publish(\r\n    exchange='',\r\n    routing_key='ModelTraining',\r\n    body=json.dumps({\r\n        'batchId': batch_id,\r\n        'totalImages': len(augmentations)\r\n    })\r\n)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-conclus\xe3o",children:"\ud83d\udcdd Conclus\xe3o"}),"\n",(0,i.jsxs)(n.p,{children:["O ",(0,i.jsx)(n.strong,{children:"OColecionadorAugmentations"})," \xe9 um servi\xe7o robusto e escal\xe1vel que:"]}),"\n",(0,i.jsxs)(n.p,{children:["\u2705 Consome mensagens de forma ass\xedncrona",(0,i.jsx)(n.br,{}),"\n","\u2705 Aplica transforma\xe7\xf5es profissionais",(0,i.jsx)(n.br,{}),"\n","\u2705 Trata erros e retries com eleg\xe2ncia",(0,i.jsx)(n.br,{}),"\n","\u2705 Integra com infraestrutura moderna",(0,i.jsx)(n.br,{}),"\n","\u2705 Persiste metadados para auditoria",(0,i.jsx)(n.br,{}),"\n","\u2705 Prepara dados para treinamento de IA"]})]})}function m(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);